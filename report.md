# シフトスケジュール最適化における適応度計算の分析

## 1. 多目的評価指標の統合アプローチ

現在の適応度計算システムは、以下の3つの主要な目的を統合的に評価している。

1. **希望シフトとの一致度**
   - 従業員の希望シフトと実際の割り当ての一致度を評価
   - 一致するたびに+1ポイントを加算
   - シンプルだが効果的な評価方法

2. **労働時間の均等性**
   - 標準偏差を使用して労働時間の分散を評価
   - 平均からの乖離を数値化
   - 重み付け係数（×2）により、均等性の重要度を調整

3. **時間帯ごとの適切な人員配置**
   - 希望がない時間帯の配置ペナルティ（-100）
   - 人員不足のペナルティ（-5）
   - 過剰配置のペナルティ（-10/人）

この多目的評価により、現実的な制約条件を考慮した最適化が可能となっている。

## 2. ペナルティ設計の戦略的考察

現在のペナルティ設計には以下のような戦略的な特徴がある。

1. **階層的なペナルティ構造**
   - 希望がない時間帯の配置: -100（最優先で回避）
   - 過剰配置: -10/人（次に重要な制約）
   - 人員不足: -5（比較的許容可能）

2. **重み付けの効果**
   - 労働時間の標準偏差に×2の重み付け
   - これにより、均等な労働時間配分を強く促進
   - 遺伝的アルゴリズムの探索空間を効果的に制御

このペナルティ設計により、以下の効果が期待できる。
- 制約違反の優先順位付けが明確
- アルゴリズムの収束性の向上
- 現実的な制約条件の反映

## 3. 適応度計算の改善提案

### 3.1 動的な重み付けの導入

現在の固定重み付けを改善するため、以下の動的重み付けの導入を提案する：

1. **世代に応じた重み付けの調整**
   - 初期世代：希望シフトの一致度を重視（重み: 2.0）
   - 中期世代：労働時間の均等性を重視（重み: 2.5）
   - 後期世代：人員配置の適切性を重視（重み: 3.0）

2. **適応度の進化状況に基づく調整**
   ```typescript
   const dynamicWeight = (generation: number, maxGenerations: number): number => {
     const progress = generation / maxGenerations;
     return 2.0 + (progress * 1.0); // 2.0から3.0の間で線形に増加
   };
   ```

### 3.2 より細かい評価指標の追加

1. **連続勤務の評価**
   - 連続勤務が3日を超える場合にペナルティ（-15/日）
   - 適切な休憩時間の確保を促進

2. **時間帯の偏りの評価**
   - 特定の時間帯（例：早朝・深夜）の集中を抑制
   - 時間帯ごとの勤務回数の標準偏差を計算
   - 標準偏差が大きい場合にペナルティ（-20）

3. **スキルバランスの考慮**
   ```typescript
   const evaluateSkillBalance = (schedule: ShiftSchedule, employees: Employee[]): number => {
     let penalty = 0;
     DAYS.forEach(day => {
       HOURS.forEach(hour => {
         const assignedEmployees = schedule[day][hour];
         const skillLevels = assignedEmployees.map(name => 
           employees.find(emp => emp.name === name)?.skillLevel || 0
         );
         const avgSkill = skillLevels.reduce((a, b) => a + b, 0) / skillLevels.length;
         if (avgSkill < 2.0) penalty -= 10; // 平均スキルレベルが低い場合にペナルティ
       });
     });
     return penalty;
   };
   ```

### 3.3 評価関数の最適化

1. **正規化の導入**
   ```typescript
   const normalizeFitness = (rawFitness: number, minFitness: number, maxFitness: number): number => {
     return (rawFitness - minFitness) / (maxFitness - minFitness);
   };
   ```

2. **多段階評価の実装**
   - 第1段階：基本的な制約の満足度評価
   - 第2段階：希望シフトとの一致度評価
   - 第3段階：労働時間の均等性評価
   - 各段階で閾値を設定し、段階的に評価

これらの改善により、以下の効果が期待できる：
- より現実的なシフトスケジュールの生成
- アルゴリズムの収束速度の向上
- 従業員の満足度の向上
- 運営側の管理負担の軽減
